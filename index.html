<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Super Admin - Voter Tool</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
    /* --- CSS RESET & VARS --- */
    :root {
        --primary: #2563eb;
        --sidebar-bg: #1e293b;
        --bg: #f3f4f6;
        --surface: #ffffff;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    body { background: var(--bg); display: flex; min-height: 100vh; }

    /* --- SIDEBAR --- */
    .sidebar {
        width: 250px; background: var(--sidebar-bg); color: white;
        display: flex; flex-direction: column; padding: 20px;
        position: fixed; height: 100vh;
    }
    .brand { font-size: 20px; font-weight: bold; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
    .menu-item {
        padding: 12px 15px; margin-bottom: 5px; border-radius: 8px;
        cursor: pointer; transition: 0.2s; color: #94a3b8; display: flex; align-items: center; gap: 10px;
    }
    .menu-item:hover, .menu-item.active { background: #334155; color: white; }

    /* --- MAIN CONTENT --- */
    .main { margin-left: 250px; flex: 1; padding: 30px; }
    
    /* Stats Grid */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card {
        background: var(--surface); padding: 20px; border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between;
    }
    .stat-info h3 { font-size: 28px; color: #1e293b; margin-bottom: 5px; }
    .stat-info p { color: #64748b; font-size: 14px; }
    .stat-icon { width: 50px; height: 50px; border-radius: 10px; display: grid; place-items: center; font-size: 20px; }

    /* Sections */
    .section-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #333; }
    
    /* Pending Requests Cards */
    .pending-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-bottom: 40px; }
    .req-card {
        background: white; padding: 20px; border-radius: 10px; border-left: 5px solid var(--warning);
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .req-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
    .utr-badge { background: #f1f5f9; padding: 4px 8px; border-radius: 4px; font-family: monospace; font-size: 13px; font-weight: bold; }
    .req-actions { display: flex; gap: 10px; margin-top: 15px; }

    /* Data Table */
    .table-container { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow-x: auto; }
    .search-bar { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 15px; outline: none; }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th { text-align: left; padding: 12px; border-bottom: 2px solid #f1f5f9; color: #64748b; font-size: 13px; }
    td { padding: 12px; border-bottom: 1px solid #f1f5f9; color: #333; font-size: 14px; }
    .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
    .status-premium { background: #dcfce7; color: #166534; }
    .status-free { background: #f1f5f9; color: #475569; }
    .status-expired { background: #fee2e2; color: #991b1b; }

    /* Buttons */
    .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; color: white; }
    .btn-approve { background: var(--success); }
    .btn-reject { background: var(--danger); }
    .btn-edit { background: var(--primary); }
    .btn-trash { background: #ef4444; width: 30px; height: 30px; display: inline-flex; align-items: center; justify-content: center; padding: 0; }

    /* Modal */
    .modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 100;
    }
    .modal-box { background: white; padding: 25px; width: 400px; border-radius: 12px; animation: popUp 0.3s ease; }
    @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-size: 13px; color: #64748b; }
    .form-input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; }

    @media (max-width: 768px) {
        .sidebar { display: none; }
        .main { margin-left: 0; padding: 15px; }
    }
</style>
</head>
<body>

<div class="sidebar">
    <div class="brand"><i class="fas fa-user-shield"></i> Admin Panel</div>
    <div class="menu-item active"><i class="fas fa-chart-line"></i> Dashboard</div>
    <div class="menu-item"><i class="fas fa-users"></i> Users</div>
    <div class="menu-item"><i class="fas fa-cog"></i> Settings</div>
</div>

<div class="main">
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-info"><h3 id="statTotal">0</h3><p>Total Users</p></div>
            <div class="stat-icon" style="background:#eff6ff; color:#2563eb;"><i class="fas fa-users"></i></div>
        </div>
        <div class="stat-card">
            <div class="stat-info"><h3 id="statPremium">0</h3><p>Active Premium</p></div>
            <div class="stat-icon" style="background:#dcfce7; color:#16a34a;"><i class="fas fa-crown"></i></div>
        </div>
        <div class="stat-card">
            <div class="stat-info"><h3 id="statPending">0</h3><p>Pending Requests</p></div>
            <div class="stat-icon" style="background:#fff7ed; color:#ea580c;"><i class="fas fa-clock"></i></div>
        </div>
    </div>

    <h3 class="section-title">Pending Approvals</h3>
    <div id="pendingContainer" class="pending-grid">
        <div style="color:#64748b; font-style:italic;">No pending requests.</div>
    </div>

    <h3 class="section-title" style="margin-top: 30px;">All Users Management</h3>
    <div class="table-container">
        <input type="text" id="searchInput" class="search-bar" placeholder="Search by email..." onkeyup="filterUsers()">
        <table>
            <thead>
                <tr>
                    <th>Email</th>
                    <th>Status</th>
                    <th>Expires</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="userTableBody">
                </tbody>
        </table>
    </div>

</div>

<div id="editModal" class="modal">
    <div class="modal-box">
        <h3 style="margin-bottom:15px;">Edit User Access</h3>
        <input type="hidden" id="editUid">
        
        <div class="form-group">
            <label>Email</label>
            <input id="editEmail" class="form-input" disabled style="background:#f1f5f9;">
        </div>

        <div class="form-group">
            <label>Plan Status</label>
            <select id="editPlan" class="form-input">
                <option value="free">Free / Expired</option>
                <option value="premium">Premium</option>
            </select>
        </div>

        <div class="form-group">
            <label>Subscription Expiry (Epoch ms)</label>
            <input type="date" id="editDate" class="form-input">
        </div>

        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
            <button onclick="closeModal()" class="btn" style="background:#cbd5e1; color:#333;">Cancel</button>
            <button onclick="saveUserChanges()" class="btn btn-approve">Save Changes</button>
        </div>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getFirestore, collection, query, onSnapshot, doc, updateDoc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDZLakPR2A5wQ7okDL-L7nCSxJDICiMtEQ",
    authDomain: "voter-5e759.firebaseapp.com",
    projectId: "voter-5e759",
    storageBucket: "voter-5e759.firebasestorage.app",
    messagingSenderId: "118588658962",
    appId: "1:118588658962:web:048048d4e8593e95580fcb",
    measurementId: "G-C6BPLSF9W7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let globalUsers = []; // Store users for searching

  // --- REALTIME LISTENER FOR ALL USERS ---
  const q = query(collection(db, "users"), orderBy("joinedAt", "desc"));

  onSnapshot(q, (snapshot) => {
      const users = [];
      let pendingCount = 0;
      let premiumCount = 0;

      snapshot.forEach(docSnap => {
          const data = docSnap.data();
          data.uid = docSnap.id;
          users.push(data);

          // Stats Logic
          if(data.paymentStatus === 'pending') pendingCount++;
          if(data.subscriptionExpiry > Date.now()) premiumCount++;
      });

      globalUsers = users;
      updateStats(users.length, premiumCount, pendingCount);
      renderPending(users);
      renderTable(users);
  });

  // --- RENDER FUNCTIONS ---
  function updateStats(total, prem, pend) {
      document.getElementById("statTotal").innerText = total;
      document.getElementById("statPremium").innerText = prem;
      document.getElementById("statPending").innerText = pend;
  }

  function renderPending(users) {
      const container = document.getElementById("pendingContainer");
      container.innerHTML = "";
      
      const pendingUsers = users.filter(u => u.paymentStatus === "pending");

      if(pendingUsers.length === 0) {
          container.innerHTML = '<div style="grid-column: 1/-1; text-align:center; color:#94a3b8; padding:20px;">No pending requests currently.</div>';
          return;
      }

      pendingUsers.forEach(u => {
          const card = document.createElement("div");
          card.className = "req-card";
          card.innerHTML = `
              <div class="req-header">
                  <strong>${u.email}</strong>
                  <span class="utr-badge">${u.utrNumber || 'No UTR'}</span>
              </div>
              <div style="font-size:12px; color:#64748b;">
                  Submitted: ${new Date(u.submittedAt).toLocaleString()}
              </div>
              <div class="req-actions">
                  <button class="btn btn-approve" style="flex:1" onclick="handlePayment('${u.uid}', true, '${u.email}')">Accept</button>
                  <button class="btn btn-reject" style="flex:1" onclick="handlePayment('${u.uid}', false)">Reject</button>
              </div>
          `;
          container.appendChild(card);
      });
  }

  function renderTable(users) {
      const tbody = document.getElementById("userTableBody");
      tbody.innerHTML = "";

      users.forEach(u => {
          const isPremium = u.subscriptionExpiry > Date.now();
          const isPending = u.paymentStatus === "pending";
          
          let badgeClass = "status-free";
          let statusText = "Free/Expired";
          
          if(isPending) { badgeClass = "status-expired"; statusText = "Pending"; } // Red/Orange for attention
          else if(isPremium) { badgeClass = "status-premium"; statusText = "Premium"; }

          const expiryDate = u.subscriptionExpiry ? new Date(u.subscriptionExpiry).toLocaleDateString() : "-";

          const tr = document.createElement("tr");
          tr.innerHTML = `
              <td>${u.email} <br><span style="font-size:11px; color:#94a3b8;">UID: ${u.uid.substr(0,8)}...</span></td>
              <td><span class="status-badge ${badgeClass}">${statusText}</span></td>
              <td>${expiryDate}</td>
              <td>
                  <button class="btn btn-edit" onclick="openEditModal('${u.uid}')"><i class="fas fa-pen"></i></button>
                  <button class="btn btn-trash" onclick="deleteUser('${u.uid}')"><i class="fas fa-trash"></i></button>
              </td>
          `;
          tbody.appendChild(tr);
      });
  }

  // --- ACTIONS ---

  // 1. Approve/Reject Logic
  window.handlePayment = async (uid, isApproved, email) => {
      if(isApproved) {
          if(!confirm(`Approve payment for ${email}?`)) return;
          // Add 30 Days
          const newExpiry = Date.now() + (30 * 24 * 60 * 60 * 1000);
          await updateDoc(doc(db, "users", uid), {
              paymentStatus: "approved",
              subscriptionExpiry: newExpiry,
              approvedAt: Date.now()
          });
      } else {
          if(!confirm("Reject this request?")) return;
          await updateDoc(doc(db, "users", uid), {
              paymentStatus: "rejected",
              rejectedAt: Date.now()
          });
      }
  };

  // 2. Delete User
  window.deleteUser = async (uid) => {
      if(confirm("Are you sure? This will delete the user's data permanently.")) {
          await deleteDoc(doc(db, "users", uid));
          // Note: This deletes Firestore data. It does NOT delete Authentication user.
          // To delete Auth user, you need Cloud Functions or Admin SDK (Server Side).
      }
  };

  // 3. Edit User (Modal Logic)
  window.openEditModal = (uid) => {
      const user = globalUsers.find(u => u.uid === uid);
      if(!user) return;

      document.getElementById("editModal").style.display = "flex";
      document.getElementById("editUid").value = uid;
      document.getElementById("editEmail").value = user.email;
      
      // Set Plan Select
      const isPremium = user.subscriptionExpiry > Date.now();
      document.getElementById("editPlan").value = isPremium ? "premium" : "free";

      // Set Date Input (Convert timestamp to YYYY-MM-DD)
      if(user.subscriptionExpiry) {
          const d = new Date(user.subscriptionExpiry);
          document.getElementById("editDate").value = d.toISOString().split('T')[0];
      } else {
          document.getElementById("editDate").value = "";
      }
  };

  window.closeModal = () => {
      document.getElementById("editModal").style.display = "none";
  };

  window.saveUserChanges = async () => {
      const uid = document.getElementById("editUid").value;
      const plan = document.getElementById("editPlan").value;
      const dateStr = document.getElementById("editDate").value;

      let newExpiry = 0;

      if(plan === "premium") {
          if(dateStr) {
              newExpiry = new Date(dateStr).getTime();
          } else {
              // Default to 30 days from now if no date picked but premium selected
              newExpiry = Date.now() + (30 * 24 * 60 * 60 * 1000);
          }
      } else {
          newExpiry = 0; // Reset to free
      }

      await updateDoc(doc(db, "users", uid), {
          subscriptionExpiry: newExpiry,
          // If we manually set to premium, clear any pending status logic
          paymentStatus: plan === "premium" ? "approved" : "none"
      });

      closeModal();
      alert("User updated successfully");
  };

  // 4. Search Filter
  window.filterUsers = () => {
      const input = document.getElementById("searchInput").value.toLowerCase();
      const filtered = globalUsers.filter(u => u.email.toLowerCase().includes(input));
      renderTable(filtered);
  };

</script>

</body>
</html>
